<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aviator Crash Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #111827;
      color: white;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 1rem;
    }
  </style>
</head>
<body>
  <div id="root" class="w-full max-w-md"></div>

  <script type="text/javascript">
    const { useState, useEffect, useRef } = React;

    // Utility functions for crypto (sha256 and hmac-sha256) using Web Crypto API
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');
    }

    async function hmacSha256(key, message) {
      const enc = new TextEncoder();
      const keyData = enc.encode(key);
      const cryptoKey = await crypto.subtle.importKey(
        'raw',
        keyData,
        { name: 'HMAC', hash: 'SHA-256' },
        false,
        ['sign']
      );
      const sig = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(message));
      const sigArray = Array.from(new Uint8Array(sig));
      return sigArray.map((b) => b.toString(16).padStart(2, '0')).join('');
    }

    function ProvablyFairVerification() {
      const [serverSeed, setServerSeed] = useState('');
      const [clientSeed, setClientSeed] = useState('');
      const [expectedHash, setExpectedHash] = useState('');
      const [calculatedHash, setCalculatedHash] = useState('');
      const [hmac, setHmac] = useState('');
      const [multiplier, setMultiplier] = useState(null);

      async function verify() {
        const hash = await sha256(serverSeed);
        setCalculatedHash(hash);
        if (hash !== expectedHash) {
          alert('Server seed hash does not match expected hash');
          return;
        }
        const hmacVal = await hmacSha256(serverSeed, clientSeed);
        setHmac(hmacVal);
        const hmacSlice = hmacVal.slice(0, 13);
        const intVal = parseInt(hmacSlice, 16);
        const maxVal = Math.pow(2, 52);
        if (intVal >= maxVal) {
          setMultiplier(1);
          return;
        }
        const result = Math.floor((99 / (1 - intVal / maxVal))) / 100;
        setMultiplier(result < 1 ? 1 : result);
      }

      return (
        React.createElement("div", { className: "bg-gray-800 p-4 rounded max-w-md mx-auto my-4 text-white" },
          React.createElement("h3", { className: "text-xl font-bold mb-2" }, "Provably Fair Verification"),
          React.createElement("label", { className: "block mb-1" }, "Server Seed (hex):"),
          React.createElement("input", {
            type: "text",
            className: "w-full p-2 mb-2 rounded text-black",
            value: serverSeed,
            onChange: e => setServerSeed(e.target.value)
          }),
          React.createElement("label", { className: "block mb-1" }, "Expected Server Seed Hash (hex):"),
          React.createElement("input", {
            type: "text",
            className: "w-full p-2 mb-2 rounded text-black",
            value: expectedHash,
            onChange: e => setExpectedHash(e.target.value)
          }),
          React.createElement("label", { className: "block mb-1" }, "Client Seed (hex):"),
          React.createElement("input", {
            type: "text",
            className: "w-full p-2 mb-2 rounded text-black",
            value: clientSeed,
            onChange: e => setClientSeed(e.target.value)
          }),
          React.createElement("button", {
            onClick: verify,
            className: "bg-blue-600 px-4 py-2 rounded hover:bg-blue-700"
          }, "Verify"),
          calculatedHash && React.createElement("p", { className: "mt-2" },
            "Calculated Server Seed Hash: ",
            React.createElement("code", null, calculatedHash)
          ),
          hmac && React.createElement("p", null,
            "HMAC-SHA256: ",
            React.createElement("code", null, hmac)
          ),
          multiplier !== null && React.createElement("p", null,
            "Calculated Crash Multiplier: ",
            React.createElement("strong", null, multiplier.toFixed(2) + "x")
          )
        )
      );
    }

    function Wallet({ token, onBalanceChange }) {
      const [depositAmount, setDepositAmount] = useState('');
      const [withdrawAmount, setWithdrawAmount] = useState('');
      const [message, setMessage] = useState('');

      async function deposit() {
        const amount = parseFloat(depositAmount);
        if (isNaN(amount) || amount <= 0) {
          setMessage('Invalid deposit amount');
          return;
        }
        try {
          const res = await axios.post(
            '/api/game/deposit',
            { amount },
            { headers: { Authorization: `Bearer ${token}` } }
          );
          setMessage(`Deposit initiated. TxID: ${res.data.txId}`);
          setDepositAmount('');
          onBalanceChange(await fetchBalance());
        } catch {
          setMessage('Deposit failed');
        }
      }

      async function withdraw() {
        const amount = parseFloat(withdrawAmount);
        if (isNaN(amount) || amount <= 0) {
          setMessage('Invalid withdraw amount');
          return;
        }
        try {
          const res = await axios.post(
            '/api/game/withdraw',
            { amount },
            { headers: { Authorization: `Bearer ${token}` } }
          );
          setMessage(`Withdraw initiated. TxID: ${res.data.txId}`);
          setWithdrawAmount('');
          onBalanceChange(await fetchBalance());
        } catch {
          setMessage('Withdraw failed');
        }
      }

      async function fetchBalance() {
        try {
          const res = await axios.get('/api/game/wallet', {
            headers: { Authorization: `Bearer ${token}` },
          });
          return res.data.walletBalance;
        } catch {
          return 0;
        }
      }

      return (
        React.createElement("div", { className: "bg-gray-800 p-4 rounded mb-4" },
          React.createElement("h3", { className: "text-lg font-semibold mb-2" }, "Wallet"),
          React.createElement("div", { className: "flex space-x-2 mb-2" },
            React.createElement("input", {
              type: "number",
              min: "0.01",
              step: "0.01",
              placeholder: "Deposit amount",
              className: "p-2 rounded text-black flex-1",
              value: depositAmount,
              onChange: e => setDepositAmount(e.target.value)
            }),
            React.createElement("button", {
              onClick: deposit,
              className: "bg-green-600 px-4 py-2 rounded hover:bg-green-700"
            }, "Deposit")
          ),
          React.createElement("div", { className: "flex space-x-2 mb-2" },
            React.createElement("input", {
              type: "number",
              min: "0.01",
              step: "0.01",
              placeholder: "Withdraw amount",
              className: "p-2 rounded text-black flex-1",
              value: withdrawAmount,
              onChange: e => setWithdrawAmount(e.target.value)
            }),
            React.createElement("button", {
              onClick: withdraw,
              className: "bg-red-600 px-4 py-2 rounded hover:bg-red-700"
            }, "Withdraw")
          ),
          message && React.createElement("p", { className: "text-sm text-yellow-400" }, message)
        )
      );
    }

    function KYC({ token }) {
      const [file, setFile] = useState(null);
      const [status, setStatus] = useState('unknown');
      const [message, setMessage] = useState('');

      useEffect(() => {
        fetchStatus();
      }, []);

      async function fetchStatus() {
        try {
          const res = await axios.get('/api/kyc/status', {
            headers: { Authorization: `Bearer ${token}` },
          });
          setStatus(res.data.kycStatus);
        } catch {
          setStatus('unknown');
        }
      }

      async function upload() {
        if (!file) {
          setMessage('Please select a file');
          return;
        }
        const formData = new FormData();
        formData.append('idDocument', file);
        try {
          await axios.post('/api/kyc/upload_id', formData, {
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'multipart/form-data',
            },
          });
          setMessage('ID uploaded, verification pending');
          fetchStatus();
        } catch {
          setMessage('Upload failed');
        }
      }

      return (
        React.createElement("div", { className: "bg-gray-800 p-4 rounded mb-4 max-w-md mx-auto text-white" },
          React.createElement("h3", { className: "text-lg font-semibold mb-2" }, "KYC Verification"),
          React.createElement("p", null, "Status: ", React.createElement("strong", null, status)),
          React.createElement("input", {
            type: "file",
            accept: "image/*,application/pdf",
            onChange: e => setFile(e.target.files ? e.target.files[0] : null),
            className: "my-2 text-black"
          }),
          React.createElement("button", {
            onClick: upload,
            className: "bg-blue-600 px-4 py-2 rounded hover:bg-blue-700"
          }, "Upload ID Document"),
          message && React.createElement("p", { className: "mt-2 text-yellow-400" }, message)
        )
      );
    }

    function AdminPanel({ token }) {
      const [logs, setLogs] = useState([]);
      const [action, setAction] = useState('');
      const [message, setMessage] = useState('');
      const [loading, setLoading] = useState(false);

      useEffect(() => {
        fetchLogs();
      }, []);

      async function fetchLogs() {
        try {
          const res = await axios.get('/api/admin/logs', {
            headers: { Authorization: `Bearer ${token}` },
          });
          setLogs(res.data);
        } catch {
          setMessage('Failed to fetch logs');
        }
      }

      async function logAction() {
        if (!action.trim()) {
          setMessage('Action cannot be empty');
          return;
        }
        setLoading(true);
        try {
          await axios.post(
            '/api/admin/log_action',
            { action },
            { headers: { Authorization: `Bearer ${token}` } }
          );
          setMessage('Action logged');
          setAction('');
          fetchLogs();
        } catch {
          setMessage('Failed to log action');
        } finally {
          setLoading(false);
        }
      }

      return (
        React.createElement("div", { className: "bg-gray-800 p-4 rounded max-w-4xl mx-auto my-4 text-white" },
          React.createElement("h3", { className: "text-xl font-bold mb-4" }, "Admin Panel"),
          React.createElement("div", { className: "mb-4" },
            React.createElement("textarea", {
              rows: 3,
              className: "w-full p-2 rounded text-black",
              placeholder: "Enter admin action description",
              value: action,
              onChange: e => setAction(e.target.value),
              disabled: loading
            }),
            React.createElement("button", {
              onClick: logAction,
              disabled: loading,
              className: "mt-2 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50"
            }, "Log Action"),
            message && React.createElement("p", { className: "mt-2 text-yellow-400" }, message)
          ),
          React.createElement("h4", { className: "text-lg font-semibold mb-2" }, "Recent Admin Logs"),
          React.createElement("div", { className: "overflow-auto max-h-96 border border-gray-700 rounded" },
            React.createElement("table", { className: "w-full text-sm text-left" },
              React.createElement("thead", { className: "bg-gray-700 sticky top-0" },
                React.createElement("tr", null,
                  React.createElement("th", { className: "px-2 py-1" }, "Timestamp"),
                  React.createElement("th", { className: "px-2 py-1" }, "Admin ID"),
                  React.createElement("th", { className: "px-2 py-1" }, "Action"),
                  React.createElement("th", { className: "px-2 py-1" }, "IP"),
                  React.createElement("th", { className: "px-2 py-1" }, "Signature")
                )
              ),
              React.createElement("tbody", null,
                logs.map(log =>
                  React.createElement("tr", { key: log._id, className: "border-b border-gray-700" },
                    React.createElement("td", { className: "px-2 py-1" }, new Date(log.timestamp).toLocaleString()),
                    React.createElement("td", { className: "px-2 py-1" }, log.adminId),
                    React.createElement("td", { className: "px-2 py-1 break-words max-w-xs" }, log.action),
                    React.createElement("td", { className: "px-2 py-1" }, log.ip),
                    React.createElement("td", { className: "px-2 py-1 break-words max-w-xs" }, log.signature)
                  )
                )
              )
            )
          )
        )
      );
    }

    function PromoteSelf({ token, onPromoted }) {
      const [loading, setLoading] = useState(false);
      const [message, setMessage] = useState('');

      async function promote() {
        setLoading(true);
        setMessage('');
        try {
          const res = await axios.post(
            '/api/admin/promote_self',
            {},
            { headers: { Authorization: `Bearer ${token}` } }
          );
          if (res.data.success) {
            setMessage('You are now an admin!');
            onPromoted();
          } else {
            setMessage('Promotion failed');
          }
        } catch {
          setMessage('Promotion failed');
        } finally {
          setLoading(false);
        }
      }

      return (
        React.createElement("div", { className: "bg-yellow-700 p-4 rounded mb-4 max-w-md mx-auto text-white text-center" },
          React.createElement("p", { className: "mb-2 font-semibold" }, "You are not an admin yet."),
          React.createElement("button", {
            onClick: promote,
            disabled: loading,
            className: "bg-yellow-500 px-4 py-2 rounded hover:bg-yellow-600 disabled:opacity-50"
          }, loading ? "Promoting..." : "Promote Me to Admin"),
          message && React.createElement("p", { className: "mt-2" }, message)
        )
      );
    }

    function Register({ onRegistered }) {
      const [username, setUsername] = useState('');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [message, setMessage] = useState('');

      async function register() {
        if (!username || !email || !password) {
          setMessage('Please fill all fields');
          return;
        }
        try {
          await axios.post('/api/auth/register', { username, email, password });
          setMessage('Registration successful! Please login.');
          onRegistered();
        } catch (e) {
          setMessage(e.response?.data?.error || 'Registration failed');
        }
      }

      return (
        React.createElement("div", { className: "min-h-screen flex flex-col items-center justify-center bg-gray-900 text-white p-4" },
          React.createElement("h1", { className: "text-3xl font-bold mb-6" }, "Register"),
          React.createElement("input", {
            type: "text",
            placeholder: "Username",
            className: "mb-2 p-2 rounded text-black w-64",
            value: username,
            onChange: e => setUsername(e.target.value)
          }),
          React.createElement("input", {
            type: "email",
            placeholder: "Email",
            className: "mb-2 p-2 rounded text-black w-64",
            value: email,
            onChange: e => setEmail(e.target.value)
          }),
          React.createElement("input", {
            type: "password",
            placeholder: "Password",
            className: "mb-4 p-2 rounded text-black w-64",
            value: password,
            onChange: e => setPassword(e.target.value)
          }),
          React.createElement("button", {
            onClick: register,
            className: "bg-green-600 px-6 py-2 rounded hover:bg-green-700 transition"
          }, "Register"),
          message && React.createElement("p", { className: "mt-4 text-yellow-400" }, message)
        )
      );
    }

    function App() {
      const [token, setToken] = useState(null);
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [loggedInUser, setLoggedInUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [adminPromoted, setAdminPromoted] = useState(false);
      const [socket, setSocket] = useState(null);
      const [roundId, setRoundId] = useState('');
      const [serverSeedHash, setServerSeedHash] = useState('');
      const [betCloseIn, setBetCloseIn] = useState(0);
      const [multiplier, setMultiplier] = useState(1);
      const [crashMultiplier, setCrashMultiplier] = useState(null);
      const [betAmount, setBetAmount] = useState(0);
      const [betPlaced, setBetPlaced] = useState(false);
      const [cashedOut, setCashedOut] = useState(false);
      const [walletBalance, setWalletBalance] = useState(0);
      const [messages, setMessages] = useState([]);
      const [showRegister, setShowRegister] = useState(false);
      const [loginError, setLoginError] = useState('');

      const multiplierRef = useRef(multiplier);
      multiplierRef.current = multiplier;

      useEffect(() => {
        if (token) {
          const s = io(socketUrl, {
            auth: { token },
          });
          setSocket(s);

          s.on('connect_error', (err) => {
            addMessage(`Socket error: ${err.message}`);
          });

          s.on('round_start', (data) => {
            setRoundId(data.roundId);
            setServerSeedHash(data.serverSeedHash);
            setBetCloseIn(data.bet_close_in);
            setMultiplier(1);
            setCrashMultiplier(null);
            setBetPlaced(false);
            setCashedOut(false);
            addMessage(`Round started: ${data.roundId}`);
          });

          s.on('multiplier_update', (data) => {
            setMultiplier(data.multiplier);
          });

          s.on('round_crash', (data) => {
            setCrashMultiplier(data.crashMultiplier);
            addMessage(`Round crashed at ${data.crashMultiplier}x`);
          });

          s.on('payouts', (data) => {
            addMessage(`Payouts processed for round ${data.roundId}`);
            refreshWallet();
          });

          s.on('error', (data) => {
            addMessage(`Error: ${data.message}`);
          });

          refreshWallet();

          return () => {
            s.disconnect();
          };
        }
      }, [token]);

      async function refreshWallet() {
        if (!token) return;
        try {
          const res = await axios.get('/api/game/wallet', {
            headers: { Authorization: `Bearer ${token}` },
          });
          setWalletBalance(res.data.walletBalance);
        } catch {
          setWalletBalance(0);
        }
      }

      async function login() {
        setLoginError('');
        try {
          const res = await axios.post('/api/auth/login', { username, password });
          setToken(res.data.token);
          setLoggedInUser(res.data.user);
          setUserRole(res.data.user.role);
          setAdminPromoted(res.data.user.role === 'admin');
          setUsername('');
          setPassword('');
        } catch (e) {
          setLoginError(e.response?.data?.error || 'Login failed');
        }
      }

      async function placeBet() {
        if (!socket || betAmount <= 0 || betPlaced) return;
        socket.emit('place_bet', { roundId, amount: betAmount });
        setBetPlaced(true);
        addMessage(`Bet placed: ${betAmount}`);
      }

      async function cashOut() {
        if (!socket || cashedOut || !betPlaced) return;
        socket.emit('cashout', { roundId });
        setCashedOut(true);
        addMessage(`Cashed out at ${multiplierRef.current}x`);
      }

      function addMessage(msg) {
        setMessages(m => [...m.slice(-19), msg]);
      }

      if (!token) {
        if (showRegister) {
          return (
            React.createElement(React.Fragment, null,
              React.createElement(Register, { onRegistered: () => setShowRegister(false) }),
              React.createElement("div", { className: "text-center mt-4 text-white" },
                "Already have an account? ",
                React.createElement("button", {
                  onClick: () => setShowRegister(false),
                  className: "underline hover:text-gray-300"
                }, "Login here")
              )
            )
          );
        }
        return (
          React.createElement("div", { className: "min-h-screen flex flex-col items-center justify-center bg-gray-900 text-white p-4" },
            React.createElement("h1", { className: "text-3xl font-bold mb-6" }, "Aviator Crash Game"),
            React.createElement("input", {
              type: "text",
              placeholder: "Username",
              className: "mb-2 p-2 rounded text-black w-64",
              value: username,
              onChange: e => setUsername(e.target.value)
            }),
            React.createElement("input", {
              type: "password",
              placeholder: "Password",
              className: "mb-4 p-2 rounded text-black w-64",
              value: password,
              onChange: e => setPassword(e.target.value)
            }),
            React.createElement("button", {
              onClick: login,
              className: "bg-green-600 px-6 py-2 rounded hover:bg-green-700 transition"
            }, "Login"),
            loginError && React.createElement("p", { className: "mt-4 text-yellow-400" }, loginError),
            React.createElement("div", { className: "text-center mt-4" },
              "Don't have an account? ",
              React.createElement("button", {
                onClick: () => setShowRegister(true),
                className: "underline hover:text-gray-300"
              }, "Register here")
            )
          )
        );
      }

      return (
        React.createElement("div", { className: "min-h-screen bg-gray-900 text-white p-4 flex flex-col max-w-md mx-auto" },
          React.createElement("header", { className: "flex justify-between items-center mb-4" },
            React.createElement("h1", { className: "text-2xl font-bold" }, "Aviator Crash"),
            React.createElement("div", null, "Wallet: $", walletBalance.toFixed(2))
          ),

          React.createElement(Wallet, { token: token, onBalanceChange: setWalletBalance }),

          React.createElement(KYC, { token: token }),

          token && userRole !== 'admin' && !adminPromoted && React.createElement(PromoteSelf, {
            token: token,
            onPromoted: () => {
              setUserRole('admin');
              setAdminPromoted(true);
            }
          }),

          React.createElement("div", { className: "bg-gray-800 rounded p-4 mb-4 flex flex-col items-center" },
            React.createElement("div", { className: "text-sm mb-1" }, "Round ID: ", roundId),
            React.createElement("div", { className: "text-xs mb-2 break-all" }, "Server Seed Hash: ", serverSeedHash),
            React.createElement("div", { className: "text-6xl font-extrabold mb-2" }, multiplier.toFixed(2), "x"),
            crashMultiplier && React.createElement("div", { className: "text-red-500 font-bold mb-2" }, "Crashed at ", crashMultiplier.toFixed(2), "x"),
            React.createElement("div", { className: "flex space-x-2" },
              React.createElement("input", {
                type: "number",
                min: 0.01,
                step: 0.01,
                disabled: betPlaced || !betCloseIn,
                className: "p-2 rounded text-black w-24",
                placeholder: "Bet amount",
                value: betAmount > 0 ? betAmount : '',
                onChange: e => setBetAmount(parseFloat(e.target.value))
              }),
              React.createElement("button", {
                disabled: betPlaced || !betCloseIn || betAmount <= 0 || betAmount > walletBalance,
                onClick: placeBet,
                className: "bg-blue-600 px-4 py-2 rounded disabled:opacity-50"
              }, "Place Bet"),
              React.createElement("button", {
                disabled: !betPlaced || cashedOut || multiplier <= 1,
                onClick: cashOut,
                className: "bg-yellow-500 px-4 py-2 rounded disabled:opacity-50"
              }, "Cash Out")
            )
          ),

          React.createElement(ProvablyFairVerification, null),

          token && userRole === 'admin' && React.createElement(AdminPanel, { token: token }),

          React.createElement("div", { className: "bg-gray-800 rounded p-4 flex-1 overflow-auto" },
            React.createElement("h2", { className: "text-lg font-semibold mb-2" }, "Messages"),
            React.createElement("ul", { className: "text-sm space-y-1 max-h-48 overflow-y-auto" },
              messages.map((m, i) => React.createElement("li", { key: i }, m))
            )
          )
        )
      );
    }

    const socketUrl = window.location.origin.replace(/^http/, 'ws');

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>